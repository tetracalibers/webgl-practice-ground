---
title: クォータニオン
category: math
---

## 回転行列の難点

### メモリ

回転には3つ（ピッチ、ヨー、ロール）しか自由度がないにも関わらず、回転行列は9つの要素を持つ。

### 演算コスト

ベクトルと行列の乗算は3つのドット積（9つの乗算と6つの加算）を必要とする。

### 補間の難しさ

例えば、始点Aから終点Bまでカメラをスムーズに動かす際に、AとBの中間の多数の回転を見つけなければならない。

2つの姿勢が行列で表されていると、その間の指定された割合の回転を見つけることは難しい。

## 単位クォータニオン

次の制約に従うクォータニオンを**単位クォータニオン**という。

$$
q = (x, y, z, w) \quad \text{where} \quad x^2 + y^2 + z^2 + w^2 = 1
$$

単位クォータニオンは3次元ベクトルに4番目のスカラー座標をプラスしたものとして、3次元の回転を表すことができる。

- ベクトル部分である$\bold{q}_v$は回転の単位軸であり、回転角の半角の正弦でスケールされる
- スカラー部分である$q_s$は回転角の半角の余弦

$$
q = (\bold{q}_v, q_s)
  = \left(\bold{a}\sin\frac{\theta}{2}, \cos\frac{\theta}{2}\right)
$$

$\bold{a}$は回転軸に沿った単位ベクトルであり、$\theta$は回転角。

回転方向は右手の法則に従うので、親指が$\bold{a}$の方向を向いていれば、正の回転は折り曲げた指の方向を向くことになる。

## クォータニオンのグラスマン積

2つのクォータニオン$p$と$q$がそれぞれ2つの回転$\bold{P}$と$\bold{Q}$を表すとする。

このとき、クォータニオンの積$pq$は、回転$\bold{Q}$の後に回転$\bold{P}$を適用する複合回転を表す。

$$
\begin{aligned}
pq &= (\bold{p}_v, p_s)(\bold{q}_v, q_s) \\
   &= (\bold{p}_v q_s + \bold{q}_v p_s + \bold{p}_v \times \bold{q}_v, p_s q_s - \bold{p}_v \cdot \bold{q}_v)
\end{aligned}
$$

このように定義した積を**グラスマン積**という。

## クォータニオンの共役

クォータニオン$p$の**共役**$p^*$は、ベクトル部分の符号を反転させたものである。

$$
p^* = (-\bold{p}_v, p_s)
$$

## クォータニオンの逆数

クォータニオン$p$の**逆数**は$p^{-1}$と表し、元のクォータニオンを乗算したときに、スカラーの1となるクォータニオンとして定義する。

$$
pp^{-1} = 0\bold{i} + 0\bold{j} + 0\bold{k} + 1 = 1
$$

最初の3つの成分は$\sin(0) = 0$より、最後の成分は$\cos(0) = 1$より導かれる。

ところで、$\sin(-\theta) = -\sin(\theta)$であるため、ベクトル部分の符号を反転させたもの（共役）が、逆回転を表すクォータニオンだと考えられる。

数学的には、クォータニオンの逆数は、元のクォータニオンの共役を、元のクォータニオンのノルムの2乗で割ったものとして求められる。

$$
p^{-1} = \frac{p^*}{|p|^2}
$$

3D回転を表すクォータニオンでは、ノルムは常に1であるので、想像通り逆数は共役と等しくなる。

ノルムの計算は2乗での除算というコストが高い処理であるため、それを避けられるのは好都合である。

## 積の逆数と共役

クォータニオンの積の共役は、個々のクォータニオンの共役の、逆順の積に等しい。

$$
(pq)^* = q^* p^*
$$

同様に、クォータニオンの積の逆数は、個々のクォータニオンの逆数の、逆順の積に等しい。

$$
(pq)^{-1} = q^{-1} p^{-1}
$$

## ベクトルを回転させる

ベクトル$\bold{v}$に対応するクォータニオンは、ベクトルの成分をベクトル部分に、スカラーの0をスカラー部分に持つクォータニオンである。

$$
\bold{v} = (v_x, v_y, v_z, 0)
$$

ベクトル$\bold{v}$をクォータニオン$q$で回転するためには、次の式を計算する。

$$
rotate(q, \bold{v}) = q \bold{v} q^{-1}
$$

クォータニオンは必ず単位長になるので、これはクォータニオンの共役を使うのに等しい。

$$
rotate(q, \bold{v}) = q \bold{v} q^*
$$

## クォータニオンの連結

クォータニオン$q_1$、$q_2$、$q_3$がそれぞれ回転$\bold{Q}_1$、$\bold{Q}_2$、$\bold{Q}_3$を表すとする。

まず回転$\bold{Q}_1$を適用した後に回転$\bold{Q}_2$を適用し、最後に回転$\bold{Q}_3$を適用したい場合、回転後のベクトルは次のように計算できる。

$$
\begin{align*}
\bold{v}' &= q_3 q_2 q_1 \bold{v} (q_3 q_2 q_1)^{-1} \\
  &= q_3 q_2 q_1 \bold{v} q_1^{-1} q_2^{-1} q_3^{-1} \\
\end{align*}
$$

## クォータニオンの行列表現

クォータニオン$q = (\bold{q}_v, q_s) = (x, y, z, w)$とすると、回転行列$\bold{R}$は次のように求めることができる。

$$
\bold{R} = \begin{pmatrix}
1 - 2y^2 - 2z^2 & 2xy - 2zw & 2xz + 2yw \\
2xy + 2zw & 1 - 2x^2 - 2z^2 & 2yz - 2xw \\
2xz - 2yw & 2yz + 2xw & 1 - 2x^2 - 2y^2 \\
\end{pmatrix}
$$

## 回転の線形補間

回転の最も計算量が少ない補間は、4次元ベクトルの線形補間Lerpをクォータニオンに対して実行することである。

2つのクォータニオン$q_A$と$q_B$がそれぞれ回転$A$と$B$を表すとすると、次のように$A$から$B$の中間の$t$%の回転を求めることができる。

$$
\begin{align*}
lerp(q_A, q_B, t) &= \frac{q_A (1 - t) + q_B t}{|q_A (1 - t) + q_B t|} \\
&= normalize\left(\begin{pmatrix}
(1 - t)q_{Ax} + tq_{Bx} \\
(1 - t)q_{Ay} + tq_{By} \\
(1 - t)q_{Az} + tq_{Bz} \\
(1 - t)q_{Aw} + tq_{Bw} \\
\end{pmatrix}^T\right)
\end{align*}
$$

lerp演算は一般的にベクトル長を維持しないため、補間された結果のクォータニオンは再び正規化する必要がある。

## 回転の球面線形補間

lerpは球面に沿ってではなく、球の弦に沿って補間する。

このため、パラメータ$t$が一定の率で変化しても、一定の角速度を持たない（終点ではゆっくりで、途中では速くなる）回転アニメーションが生まれてしまう。

球面線形補間Slerpは、球面上を一定の角速度で回転するように補間する。

Slerpを求める公式はLerpの公式と同じだが、重み$(1 - t)$と$t$が、2つのクォータニオンがなす角の正弦を含む$w_p$と$w_q$に置き換えられている。

$$
\begin{align*}
slerp(q_A, q_B, t) &= w_p p + w_q q \\
\end{align*}
$$

ここで、

$$
\begin{align*}
w_p &= \frac{\sin((1 - t)\theta)}{\sin(\theta)} \\
w_q &= \frac{\sin(t\theta)}{\sin(\theta)} \\
\theta &= \cos^{-1}(q_A \cdot q_B)
\end{align*}
$$
